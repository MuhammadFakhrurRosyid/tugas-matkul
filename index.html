<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daftar Tugas Publik</title>
    <!-- Memuat Tailwind CSS untuk styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .custom-placeholder::placeholder { color: #9ca3af; opacity: 1; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .task-item { animation: fadeIn 0.5s ease-out; }
        /* Style untuk scrollbar kustom */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 20px; border: 3px solid transparent; background-clip: content-box; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: #6b7280; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen flex items-center justify-center p-4 transition-colors duration-300">

    <div class="w-full max-w-2xl bg-white dark:bg-gray-800 shadow-2xl rounded-2xl p-6 md:p-8">
        <header class="mb-6 text-center">
             <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white">Daftar Tugas Publik</h1>
             <p class="text-gray-500 dark:text-gray-400 mt-2">Untuk detail tugas, silakan hubungi PJ mata kuliah masing-masing ya! ğŸ˜‰</p>
        </header>

        <!-- Fitur Pencarian -->
        <div class="mb-4">
            <label for="search-input" class="sr-only">Cari Tugas</label>
            <input type="text" id="search-input" placeholder="Cari berdasarkan nama tugas atau mata kuliah..." class="custom-placeholder w-full px-4 py-3 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white border-2 border-transparent focus:border-blue-500 focus:ring-0 rounded-lg">
        </div>

        <main>
            <div id="active-tasks-container">
                <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-2 mb-4">
                    <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-300">Harus Dikerjakan</h2>
                    <div class="flex items-center gap-2">
                        <label for="sort-select" class="text-sm font-medium text-gray-600 dark:text-gray-400">Urutkan:</label>
                        <select id="sort-select" class="bg-gray-100 dark:bg-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-1.5">
                            <option value="newest">Terbaru</option>
                            <option value="oldest">Terlama</option>
                            <option value="deadline-asc">Tenggat Terdekat</option>
                            <option value="deadline-desc">Tenggat Terjauh</option>
                            <option value="course-az">Mata Kuliah (A-Z)</option>
                        </select>
                    </div>
                </div>
                <ul id="task-list" class="space-y-3 max-h-72 overflow-y-auto custom-scrollbar pr-2">
                    <li class="loading-message text-center text-gray-500 dark:text-gray-400 py-4">Memuat tugas...</li>
                </ul>
            </div>
            <div id="completed-tasks-container" class="mt-8">
                <h2 class="text-xl font-semibold mb-4 text-gray-700 dark:text-gray-300 border-b-2 border-gray-200 dark:border-gray-700 pb-2">Selesai</h2>
                <ul id="completed-task-list" class="space-y-3 max-h-60 overflow-y-auto custom-scrollbar pr-2">
                    <li class="loading-message text-center text-gray-500 dark:text-gray-400 py-4">Memuat tugas...</li>
                </ul>
            </div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collectionGroup, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // ===================================================================================
        // TODO: Pastikan konfigurasi ini SAMA PERSIS dengan di file index.html Anda
        // ===================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDgMm-W5ix_sMuEPBSHrtd-itrPwd4ge38",
            authDomain: "tugas-9ae0f.firebaseapp.com",
            projectId: "tugas-9ae0f",
            storageBucket: "tugas-9ae0f.firebasestorage.app",
            messagingSenderId: "423988894895",
            appId: "1:423988894895:web:917db3ef8f82a9a8d7885a"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- Variabel State Global ---
        let allPublicTasks = [];
        let currentSort = 'newest';
        let currentSearchTerm = '';

        // --- Elemen DOM ---
        const taskList = document.getElementById('task-list');
        const completedTaskList = document.getElementById('completed-task-list');
        const searchInput = document.getElementById('search-input');
        const sortSelect = document.getElementById('sort-select');

        // --- Event Listeners ---
        searchInput.addEventListener('input', (e) => {
            currentSearchTerm = e.target.value;
            updateDisplay();
        });
        sortSelect.addEventListener('change', (e) => {
            currentSort = e.target.value;
            updateDisplay();
        });

        // --- Logika Firestore ---
        function loadPublicTasks() {
            const tasksRef = collectionGroup(db, 'tasks');
            const q = query(tasksRef, where('isPublic', '==', true));

            onSnapshot(q, (snapshot) => {
                allPublicTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateDisplay();
            }, (error) => {
                console.error("Gagal memuat tugas publik:", error);
                taskList.innerHTML = `<li class="text-center text-red-500 py-4">Gagal memuat data. Pastikan aturan keamanan Firestore sudah benar.</li>`;
                completedTaskList.innerHTML = '';
            });
        }

        // --- Fungsi Utama untuk Render, Pencarian, dan Urutan ---
        function updateDisplay() {
            const searchLower = currentSearchTerm.toLowerCase();
            const filteredTasks = allPublicTasks.filter(task => {
                const taskText = task.text.toLowerCase();
                const courseText = (task.course || '').toLowerCase();
                return taskText.includes(searchLower) || courseText.includes(searchLower);
            });

            let activeTasks = filteredTasks.filter(task => !task.isCompleted);
            let completedTasks = filteredTasks.filter(task => task.isCompleted);

            activeTasks.sort((a, b) => {
                switch (currentSort) {
                    case 'oldest': return (a.createdAt?.toDate() || 0) - (b.createdAt?.toDate() || 0);
                    case 'deadline-asc': return sortDeadlines(a, b, true);
                    case 'deadline-desc': return sortDeadlines(a, b, false);
                    case 'course-az': return (a.course || '').localeCompare(b.course || '');
                    case 'newest': default: return (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0);
                }
            });

            taskList.innerHTML = '';
            completedTaskList.innerHTML = '';
            activeTasks.forEach(task => renderTask(task.id, task));
            completedTasks.forEach(task => renderTask(task.id, task));

            if(activeTasks.length === 0) taskList.innerHTML = `<li class="text-center text-gray-500 dark:text-gray-400 py-4">Tidak ada tugas aktif yang dipublikasikan.</li>`;
            if(completedTasks.length === 0) completedTaskList.innerHTML = `<li class="text-center text-gray-500 dark:text-gray-400 py-4">Tidak ada tugas selesai yang dipublikasikan.</li>`;
        }

        function sortDeadlines(a, b, ascending = true) {
            const dateA = a.deadline ? new Date(a.deadline) : null;
            const dateB = b.deadline ? new Date(b.deadline) : null;
            if (dateA && !dateB) return -1;
            if (!dateA && dateB) return 1;
            if (!dateA && !dateB) return 0;
            return ascending ? dateA - dateB : dateB - dateA;
        }

        // --- Fungsi Render ---
        function renderTask(id, data) {
            const li = document.createElement('li');
            li.className = 'task-item flex items-start justify-between bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg shadow-sm';
            let deadlineHTML = '';
            if (data.deadline) {
                const deadlineDate = new Date(data.deadline);
                deadlineDate.setMinutes(deadlineDate.getMinutes() + deadlineDate.getTimezoneOffset());
                const formattedDeadline = deadlineDate.toLocaleString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
                deadlineHTML = `<span class="deadline-text font-medium text-red-500 dark:text-red-400">Tenggat: ${formattedDeadline}</span>`;
            }

            li.innerHTML = `
                <div class="task-details-wrapper flex-grow min-w-0">
                    ${data.course ? `<span class="block text-xs font-bold text-blue-600 dark:text-blue-400 mb-1">${data.course}</span>` : ''}
                    <p class="task-text ${data.isCompleted ? 'line-through text-gray-500 dark:text-gray-400' : 'text-gray-800 dark:text-gray-200'} break-words">${data.text}</p>
                    <div class="metadata-wrapper flex flex-wrap items-center gap-x-4 gap-y-1 mt-1 text-xs text-gray-400 dark:text-gray-500">
                        ${deadlineHTML}
                    </div>
                </div>
                ${data.isCompleted ? '<span class="text-sm font-semibold text-green-500 pl-4">Selesai</span>' : ''}
            `;
            
            const targetList = data.isCompleted ? completedTaskList : taskList;
            targetList.appendChild(li);
        }

        loadPublicTasks();
    </script>
</body>
</html>
