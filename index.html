<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Tugas Publik</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .custom-placeholder::placeholder { color: #9ca3af; opacity: 1; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .task-item { animation: fadeIn 0.5s ease-out; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 20px; border: 3px solid transparent; background-clip: content-box; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen p-4 md:p-8">

    <div class="w-full max-w-4xl mx-auto">
        <header class="mb-6 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white">Daftar Tugas Publik</h1>
            <p class="text-gray-500 dark:text-gray-400 mt-2">Kumpulan tugas kuliah yang dibagikan oleh pengguna.</p>
        </header>

        <!-- Fitur Pencarian dan Urutan -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 sticky top-4 z-10 bg-gray-100/80 dark:bg-gray-900/80 backdrop-blur-sm p-2 rounded-xl">
             <div class="md:col-span-2">
                <label for="search-input" class="sr-only">Cari Tugas</label>
                <input type="text" id="search-input" placeholder="Cari berdasarkan nama tugas, mata kuliah, atau pembuat..." class="custom-placeholder w-full px-4 py-3 bg-white dark:bg-gray-800 text-gray-900 dark:text-white border-2 border-gray-200 dark:border-gray-700 focus:border-blue-500 focus:ring-0 rounded-lg">
            </div>
            <div class="flex items-center gap-2">
                <label for="sort-select" class="text-sm font-medium text-gray-600 dark:text-gray-400 whitespace-nowrap">Urutkan:</label>
                <select id="sort-select" class="w-full bg-white dark:bg-gray-800 text-sm rounded-lg border-2 border-gray-200 dark:border-gray-700 focus:ring-blue-500 focus:border-blue-500 p-3">
                    <option value="newest">Terbaru</option>
                    <option value="oldest">Terlama</option>
                    <option value="deadline-asc">Tenggat Terdekat</option>
                    <option value="deadline-desc">Tenggat Terjauh</option>
                    <option value="course-az">Mata Kuliah (A-Z)</option>
                </select>
            </div>
        </div>

        <main>
            <div id="active-tasks-container">
                <h2 class="text-xl font-semibold mb-4 text-gray-700 dark:text-gray-300">Harus Dikerjakan</h2>
                <ul id="task-list" class="space-y-3"></ul>
            </div>
            <div id="completed-tasks-container" class="mt-8">
                <h2 class="text-xl font-semibold mb-4 text-gray-700 dark:text-gray-300">Selesai</h2>
                <ul id="completed-task-list" class="space-y-3"></ul>
            </div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collectionGroup, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // ===================================================================================
        // TODO: Ganti dengan Konfigurasi Firebase Anda (harus sama dengan aplikasi utama)
        // ===================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDgMm-W5ix_sMuEPBSHrtd-itrPwd4ge38",
            authDomain: "tugas-9ae0f.firebaseapp.com",
            projectId: "tugas-9ae0f",
            storageBucket: "tugas-9ae0f.firebasestorage.app",
            messagingSenderId: "423988894895",
            appId: "1:423988894895:web:917db3ef8f82a9a8d7885a"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let allPublicTasks = [];
        let currentSort = 'newest';
        let currentSearchTerm = '';

        const taskList = document.getElementById('task-list');
        const completedTaskList = document.getElementById('completed-task-list');
        const searchInput = document.getElementById('search-input');
        const sortSelect = document.getElementById('sort-select');

        searchInput.addEventListener('input', (e) => {
            currentSearchTerm = e.target.value;
            updateDisplay();
        });
        sortSelect.addEventListener('change', (e) => {
            currentSort = e.target.value;
            updateDisplay();
        });

        function loadPublicTasks() {
            const tasksRef = collectionGroup(db, 'tasks');
            const q = query(tasksRef, where('isPublic', '==', true));

            onSnapshot(q, (snapshot) => {
                allPublicTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateDisplay();
            }, (error) => {
                console.error("Gagal memuat tugas publik:", error);
                taskList.innerHTML = `<li class="text-center text-red-500 py-4">Gagal memuat data. Pastikan aturan keamanan Firestore sudah benar.</li>`;
            });
        }

        function updateDisplay() {
            const searchLower = currentSearchTerm.toLowerCase();
            const filteredTasks = allPublicTasks.filter(task => {
                const taskText = task.text.toLowerCase();
                const courseText = (task.course || '').toLowerCase();
                const authorText = (task.authorName || '').toLowerCase();
                return taskText.includes(searchLower) || courseText.includes(searchLower) || authorText.includes(searchLower);
            });

            let activeTasks = filteredTasks.filter(task => !task.isCompleted);
            let completedTasks = filteredTasks.filter(task => task.isCompleted);

            activeTasks.sort((a, b) => {
                switch (currentSort) {
                    case 'oldest': return (a.createdAt?.toDate() || 0) - (b.createdAt?.toDate() || 0);
                    case 'deadline-asc': return sortDeadlines(a, b, true);
                    case 'deadline-desc': return sortDeadlines(a, b, false);
                    case 'course-az': return (a.course || '').localeCompare(b.course || '');
                    case 'newest': default: return (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0);
                }
            });
            
            completedTasks.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));

            taskList.innerHTML = '';
            completedTaskList.innerHTML = '';
            activeTasks.forEach(task => renderTask(task));
            completedTasks.forEach(task => renderTask(task));

            if(activeTasks.length === 0) taskList.innerHTML = `<li class="text-center text-gray-500 dark:text-gray-400 py-4">Tidak ada tugas aktif yang dipublikasikan.</li>`;
            if(completedTasks.length === 0) completedTaskList.innerHTML = `<li class="text-center text-gray-500 dark:text-gray-400 py-4">Belum ada tugas selesai yang dipublikasikan.</li>`;
        }

        function sortDeadlines(a, b, ascending = true) {
            const dateA = a.deadline ? new Date(a.deadline) : null;
            const dateB = b.deadline ? new Date(b.deadline) : null;
            if (dateA && !dateB) return -1;
            if (!dateA && dateB) return 1;
            if (!dateA && !dateB) return 0;
            return ascending ? dateA - dateB : dateB - dateA;
        }

        function renderTask(data) {
            const li = document.createElement('li');
            li.className = 'task-item bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md border-l-4 ' + (data.isCompleted ? 'border-gray-500' : 'border-blue-500');
            
            let deadlineHTML = '';
            if (data.deadline) {
                const deadlineDate = new Date(data.deadline);
                deadlineDate.setMinutes(deadlineDate.getMinutes() + deadlineDate.getTimezoneOffset());
                const formattedDeadline = deadlineDate.toLocaleString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
                deadlineHTML = `<span class="deadline-text font-medium text-red-500 dark:text-red-400">Tenggat: ${formattedDeadline}</span>`;
            }

            li.innerHTML = `
                <div class="flex flex-col">
                    ${data.course ? `<span class="block text-sm font-bold text-blue-600 dark:text-blue-400 mb-1">${data.course}</span>` : ''}
                    <p class="task-text text-lg font-semibold ${data.isCompleted ? 'line-through text-gray-500 dark:text-gray-400' : 'text-gray-900 dark:text-gray-100'}">${data.text}</p>
                    <div class="flex flex-wrap items-center gap-x-4 gap-y-1 mt-2 text-sm text-gray-500 dark:text-gray-400">
                        <span>Oleh: <strong>${data.authorName || 'Anonim'}</strong></span>
                        ${deadlineHTML}
                    </div>
                </div>
            `;
            
            const targetList = data.isCompleted ? completedTaskList : taskList;
            targetList.appendChild(li);
        }

        loadPublicTasks();
    </script>
</body>
</html>
